@page "/doktor-liste"

@using SAT242516005.Data
@using SAT242516005.Data.Abstract
@using SAT242516005.Localization
@using SAT242516005.Models.MyDbModels.Entities
@using Microsoft.Extensions.Localization
@using SAT242516005.Services
@using Radzen
@using Radzen.Blazor

@inject IMyDbModel_UnitOfWork UnitOfWork
@inject NavigationManager NavigationManager
@inject IStringLocalizer<AppResource> L
@inject IJSRuntime JS
@inject RaporService rapor

<div class="container mt-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h3>@L["DoktorListesi"]</h3>
        <button class="btn btn-danger" @onclick="PdfIndir">
            <i class="oi oi-document"></i> PDF Rapor Al
        </button>
    </div>

  
    <div class="card shadow-sm mb-4">
        <RadzenDataGrid AllowFiltering="true" AllowColumnResize="true" AllowSorting="true" PageSize="5" AllowPaging="true"
                        PagerHorizontalAlign="HorizontalAlign.Left" ShowPagingSummary="true"
                        Data="@doktorlar" TItem="Doktor" ColumnWidth="200px" FilterMode="FilterMode.Simple">
            <Columns>
                <RadzenDataGridColumn TItem="Doktor" Property="Ad" Title="@L["Ad"]" />
                <RadzenDataGridColumn TItem="Doktor" Property="Soyad" Title="@L["Soyad"]" />
                <RadzenDataGridColumn TItem="Doktor" Property="Brans" Title="@L["Brans"]" />
                <RadzenDataGridColumn TItem="Doktor" Title="@L["Islemler"]" Filterable="false" Sortable="false" Width="180px">
                    <Template Context="d">
                        <button class="btn btn-sm btn-primary me-1" @onclick="@(() => DuzenleHazirla(d))">
                            @L["Duzenle"]
                        </button>
                        <button class="btn btn-sm btn-danger" @onclick="@(() => Delete(d.DoktorId))">
                            @L["Sil"]
                        </button>
                    </Template>
                </RadzenDataGridColumn>
            </Columns>
        </RadzenDataGrid>
    </div>

    <div class="card shadow-sm border-primary">
        <div class="card-header bg-primary text-white">
            <h5 class="mb-0">@(seciliDoktor.DoktorId == 0 ? L["YeniDoktorEkle"] : L["Duzenle"])</h5>
        </div>
        <div class="card-body">
            <EditForm Model="@seciliDoktor" OnValidSubmit="Kaydet">
                <DataAnnotationsValidator />
                <div class="row g-3">
                    <div class="col-md-3">
                        <label class="form-label">@L["Ad"]</label>
                        <InputText @bind-Value="seciliDoktor.Ad" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">@L["Soyad"]</label>
                        <InputText @bind-Value="seciliDoktor.Soyad" class="form-control" />
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">@L["Brans"]</label>
                        <InputText @bind-Value="seciliDoktor.Brans" class="form-control" />
                    </div>
                    <div class="col-md-3 d-flex align-items-end">
                        <button type="submit" class="btn btn-success w-100">
                            @L["Kaydet"]
                        </button>
                        @if (seciliDoktor.DoktorId != 0)
                        {
                            <button type="button" class="btn btn-secondary ms-2" @onclick="FormuTemizle">@L["Iptal"]</button>
                        }
                    </div>
                </div>
                <ValidationSummary class="mt-2 text-danger" />
            </EditForm>
        </div>
    </div>
</div>

@code {
    private List<Doktor> doktorlar = new();
    private Doktor seciliDoktor = new();

    protected override async Task OnInitializedAsync()
    {
        await VerileriGetir();
    }

    private async Task VerileriGetir()
    {
  
        var liste = await UnitOfWork.Vardiyalar.GetDoktorlarAsync();
        doktorlar = liste.ToList();
    }

    private void DuzenleHazirla(Doktor d)
    {
  
        seciliDoktor = d;
    }

    private async Task Kaydet()
    {
        if (seciliDoktor.DoktorId == 0)
        {
            // YENİ KAYIT: Önce UnitOfWork üzerinden repository'e ekle
            await UnitOfWork.Vardiyalar.AddDoktorAsync(seciliDoktor);
        }
        else
        {
            // GÜNCELLEME: Mevcut nesneyi update et (EF bunu takip eder)
            await UnitOfWork.Vardiyalar.UpdateDoktorAsync(seciliDoktor);
        }

        await UnitOfWork.SaveAsync(); // Şimdi veritabanına fiziksel olarak basar
        await VerileriGetir();        // Listeyi tazele
        FormuTemizle();
    }

    private async Task Delete(int id)
    {
        await UnitOfWork.Vardiyalar.DeleteDoktorAsync(id);
        await UnitOfWork.SaveAsync();
        await VerileriGetir();
    }

    private void FormuTemizle()
    {
        seciliDoktor = new Doktor();
    }

    private async Task PdfIndir()
    {
       
        var pdfBytes = rapor.DoktorListesiPdfOlustur(doktorlar);
        var base64 = Convert.ToBase64String(pdfBytes);
        await JS.InvokeVoidAsync("downloadFile", "DoktorListesi.pdf", "application/pdf", base64);
    }
}