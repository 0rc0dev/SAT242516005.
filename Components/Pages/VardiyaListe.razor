@page "/vardiya-liste"
@using SAT242516005.Models.MyDbModels
@using SAT242516005.Models.Providers
@using SAT242516005.Localization
@using System.Globalization
@using SAT242516005.Models.MyDbModels.Entities
@inject IVardiyaProvider VardiyaProvider
@inject Microsoft.Extensions.Localization.IStringLocalizer<AppResource> L

<div class="container mt-4">
    <h3 class="mb-4">@L["VardiyaBasligi"]</h3>
    <div class="card p-4 mb-4 shadow-sm border-0 bg-light">
        <div class="row g-3">
            <div class="col-md-4">
                <label class="form-label fw-bold">@L["DoktorListesiNav"]</label>
                <select class="form-select" @bind="model.DoktorId">
                    <option value="0">-- @L["KayitliDoktorYok"] --</option>
                    @foreach (var d in doktorlar)
                    {
                        <option value="@d.DoktorId">@d.Ad @d.Soyad</option>
                    }
                </select>
            </div>
            <div class="col-md-3">
                <label class="form-label fw-bold">@L["Date"]</label>
                <InputDate class="form-control" @bind-Value="model.Tarih" />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">@L["BaslangicSaati"]</label>
                <input type="time" class="form-control" @bind="model.BaslangicSaati" />
            </div>
            <div class="col-md-2">
                <label class="form-label fw-bold">@L["BitisSaati"]</label>
                <input type="time" class="form-control" @bind="model.BitisSaati" />
            </div>
            <div class="col-md-1 d-flex align-items-end">
                <button class="btn btn-success w-100" @onclick="Kaydet">@L["Save"]</button>
            </div>
        </div>
    </div>

    <table class="table table-hover shadow-sm">
        <thead class="table-dark">
            <tr>
                <th>@L["Ad"] @L["Soyad"]</th>
                <th>@L["Date"]</th>
                <th>@L["Start"] - @L["End"]</th>
                <th></th>
            </tr>
        </thead>
        <tbody>
            @foreach (var v in vardiyalar)
            {
                <tr>
                    <td>@v.Doktor?.Ad @v.Doktor?.Soyad</td>
                    <td>@v.Tarih.ToString("d", CultureInfo.CurrentCulture)</td>
                    <td>@v.BaslangicSaati - @v.BitisSaati</td>
                    <td><button class="btn btn-danger btn-sm" @onclick="() => Sil(v.VardiyaId)">@L["Delete"]</button></td>
                </tr>
            }
        </tbody>
    </table>
</div>

@code {
    List<Vardiya> vardiyalar = new();
    List<Doktor> doktorlar = new();
    VardiyaEkleModel model = new(); // Yeni model yapısına uygun

    protected override async Task OnInitializedAsync() => await VerileriYukle();

    private async Task VerileriYukle()
    {
        doktorlar = await VardiyaProvider.GetDoktorlarAsync();
        vardiyalar = await VardiyaProvider.GetListeAsync();
    }

    async Task Kaydet()
    {
        if (model.DoktorId == 0) return;
        await VardiyaProvider.VardiyaEkleAsync(model);
        model = new VardiyaEkleModel(); // Resetleme
        await VerileriYukle();
    }

    async Task Sil(int id)
    {
        await VardiyaProvider.VardiyaSilAsync(id);
        await VerileriYukle();
    }
}